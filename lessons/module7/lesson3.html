<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 3: The this Keyword - JavaScript Journey</title>
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/themes.css">
    <link rel="stylesheet" href="../../styles/lesson.css">
    <link rel="stylesheet" href="../../styles/dark-mode-fixes.css">
    <link rel="stylesheet" href="../../styles/code-highlighting.css">
    <link rel="stylesheet" href="../../styles/footer.css">
    <link rel="stylesheet" href="../../styles/header-enhanced.css">
    <link rel="stylesheet" href="../../styles/modal.css">
    <link rel="stylesheet" href="../../styles/style-guide.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="../../index.html" style="text-decoration: none; color: inherit;">
                    <i class="fas fa-code"></i>
                    <span>JavaScript Journey</span>
                </a>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="window.location.href='../../index.html'">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" id="progressBtn">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </button>
                <button class="nav-btn" id="resetBtn">
                    <i class="fas fa-redo"></i>
                    <span>Reset</span>
                </button>
                <button class="nav-btn" id="themeBtn">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="lesson-container">
        <article class="lesson-content">
            <!-- Lesson Header -->
            <div class="lesson-header">
                <h1>Module 7:<br>Lesson 3: The this Keyword</h1>
                <p class="lesson-subtitle">Master JavaScript's most important and misunderstood keyword for object context and method binding</p>
            </div>

            <!-- Introduction Section -->
            <section class="content-section">
                <h2>Understanding this in Context</h2>
                <p>Imagine you're at a party where everyone is wearing a name tag that says "Hello, my name is..." The `this` keyword is like that name tag - it always points to whoever is currently "wearing" it. In JavaScript, `this` refers to the object that is currently executing the code, but its value can change depending on how and where a function is called.</p>
                <p>The `this` keyword is one of JavaScript's most powerful features, but also one of the most confusing for beginners. Once you understand its rules, you'll be able to write more flexible and reusable code. Think of `this` as a chameleon that changes its identity based on its environment.</p>
            </section>

            <!-- Core Content Section 1 -->
            <section class="content-section">
                <h2>this in Object Methods</h2>
                <p>When a method is called on an object, `this` refers to that object. It's like the object is saying "when you see 'this' in my methods, you're talking about me!"</p>

                <div class="info-box">
                    <div>
                        <i class="fas fa-lightbulb"></i> <strong> Key Rule:</strong>
                        <p>Inside an object method, `this` refers to the object that called the method. The object to the left of the dot when the method is called.</p>
                    </div>
                </div>

                <div class="code-editor" id="editor1">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">this in Methods</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor1')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor1')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor1-code">
// Creating multiple objects with the same methods
const cat = {
    name: "Whiskers",
    age: 3,
    species: "cat",
    
    introduce() {
        return `Hi! I'm ${this.name}, a ${this.age} year old ${this.species}.`;
    },
    
    birthday() {
        this.age++;
        return `🎂 It's my birthday! I'm now ${this.age} years old!`;
    },
    
    getName() {
        return this.name;
    }
};

const dog = {
    name: "Buddy",
    age: 5,
    species: "dog",
    
    // Same methods as cat - they work because 'this' is dynamic!
    introduce() {
        return `Hi! I'm ${this.name}, a ${this.age} year old ${this.species}.`;
    },
    
    birthday() {
        this.age++;
        return `🎂 It's my birthday! I'm now ${this.age} years old!`;
    },
    
    getName() {
        return this.name;
    }
};

console.log("=== Object Method Calls ===");
console.log("Cat says:", cat.introduce());
console.log("Dog says:", dog.introduce());

console.log("\n=== Birthday Celebrations ===");
console.log("Cat:", cat.birthday());
console.log("Dog:", dog.birthday());

console.log("\n=== After Birthdays ===");
console.log("Cat's name:", cat.getName());
console.log("Dog's name:", dog.getName());

console.log("\n=== The 'this' Context ===");
// When we call cat.introduce(), 'this' inside the method refers to 'cat'
// When we call dog.introduce(), 'this' inside the method refers to 'dog'
console.log("Cat's updated info:", cat.introduce());
console.log("Dog's updated info:", dog.introduce());
</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor1-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Core Content Section 2 -->
            <section class="content-section">
                <h2>Common this Mistakes and Solutions</h2>
                <p>The trickiest part about `this` is that it can change based on how a function is called. Here are the most common situations where `this` doesn't behave as expected:</p>

                <div class="warning-box">
                    <div>
                        <i class="fas fa-exclamation-triangle"></i> <strong> Important:</strong>
                        <p>When you extract a method from an object and call it separately, `this` loses its connection to the original object!</p>
                    </div>
                </div>

                <div class="code-editor" id="editor2">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">this Pitfalls</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor2')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor2')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor2-code">
const robot = {
    name: "R2-D2",
    energy: 100,
    
    speak() {
        return `${this.name} says: Beep boop! Energy level: ${this.energy}%`;
    },
    
    recharge() {
        this.energy = 100;
        return `${this.name} is fully recharged!`;
    }
};

console.log("=== Normal Method Calls (this works correctly) ===");
console.log(robot.speak());
robot.energy = 75;
console.log(robot.speak());

console.log("\n=== The Problem: Extracting Methods ===");
// This is where beginners often get confused!
const speakFunction = robot.speak;  // Extract the method
// Now 'this' inside speakFunction doesn't refer to robot anymore!

try {
    console.log("Extracted function:", speakFunction());
} catch (error) {
    console.log("Error:", error.message);
}

console.log("\n=== Solution 1: Always Call Methods on Objects ===");
// Keep the method attached to the object
console.log("Correct way:", robot.speak());

console.log("\n=== Solution 2: Using bind() ===");
// bind() creates a new function with 'this' permanently set
const boundSpeak = robot.speak.bind(robot);
console.log("Bound function:", boundSpeak());

console.log("\n=== Solution 3: Arrow Functions (Preview) ===");
const robotWithArrow = {
    name: "C-3PO",
    energy: 90,
    
    // Regular method for comparison
    regularSpeak() {
        return `${this.name} says: I am fluent in over 6 million forms of communication!`;
    },
    
    // Arrow function - inherits 'this' from surrounding context
    // Note: This doesn't always work as expected in objects - be careful!
    arrowSpeak: () => {
        // This 'this' doesn't refer to the object!
        return `Arrow function this: ${typeof this}`;
    }
};

console.log("\n=== Arrow Function Behavior ===");
console.log("Regular method:", robotWithArrow.regularSpeak());
console.log("Arrow method:", robotWithArrow.arrowSpeak());
</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor2-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Core Content Section 3 -->
            <section class="content-section">
                <h2>this in Different Contexts</h2>
                <p>Understanding where `this` comes from helps you predict its value. Think of `this` as being determined by the "calling context" - who is making the call and how:</p>

                <div class="code-editor" id="editor3">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">this Contexts</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor3')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor3')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor3-code">
// A timer object that demonstrates different 'this' contexts
const timer = {
    name: "CountdownTimer",
    seconds: 0,
    
    start() {
        console.log(`${this.name} is starting...`);
        return this;  // Return 'this' for method chaining
    },
    
    tick() {
        this.seconds++;
        console.log(`${this.name}: ${this.seconds} seconds`);
        return this;
    },
    
    stop() {
        console.log(`${this.name} stopped at ${this.seconds} seconds`);
        return this;
    },
    
    reset() {
        this.seconds = 0;
        console.log(`${this.name} has been reset`);
        return this;
    },
    
    getStatus() {
        return {
            name: this.name,
            seconds: this.seconds,
            isRunning: this.seconds > 0
        };
    }
};

console.log("=== Method Chaining with 'this' ===");
// Each method returns 'this', allowing us to chain method calls
timer.start().tick().tick().tick().stop().reset();

console.log("\n=== Creating Multiple Timers ===");
// Function to create timer objects
function createTimer(name) {
    return {
        name: name,
        seconds: 0,
        
        tick() {
            this.seconds++;
            console.log(`${this.name}: ${this.seconds} seconds`);
            return this;
        },
        
        getInfo() {
            return `Timer "${this.name}" is at ${this.seconds} seconds`;
        }
    };
}

const workTimer = createTimer("Work Session");
const breakTimer = createTimer("Break Time");

console.log("\n=== Independent Timer Objects ===");
workTimer.tick().tick();
breakTimer.tick();

console.log("Work timer:", workTimer.getInfo());
console.log("Break timer:", breakTimer.getInfo());

console.log("\n=== this Binding Demonstration ===");
const game = {
    playerName: "Alex",
    score: 0,
    level: 1,
    
    addPoints(points) {
        this.score += points;
        console.log(`${this.playerName} gained ${points} points! Total: ${this.score}`);
    },
    
    levelUp() {
        this.level++;
        console.log(`${this.playerName} reached level ${this.level}!`);
    },
    
    showStats() {
        return `Player: ${this.playerName} | Level: ${this.level} | Score: ${this.score}`;
    }
};

// Normal method calls - 'this' refers to game object
game.addPoints(100);
game.addPoints(50);
game.levelUp();
console.log(game.showStats());

// Storing the method in a variable
const addPointsMethod = game.addPoints;

// This would cause issues because 'this' context is lost
// We'll use bind to fix it
const boundAddPoints = game.addPoints.bind(game);
console.log("\n=== Using bound method ===");
boundAddPoints(25);  // This works because we bound 'this' to game
console.log(game.showStats());
</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor3-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Practice Exercise 1 -->
            <section class="exercise-section">
                <div class="exercise-header">
                    <h3><i class="fas fa-puzzle-piece"></i> Practice Exercise 1: Fix the this Errors</h3>
                </div>
                <div class="exercise-content">
                    <p>The code below has issues with the `this` keyword. Fix the problems so that all methods work correctly:</p>
                    
                    <div class="code-editor" id="exercise1">
                        <div class="editor-header">
                            <div class="editor-tabs">
                                <button class="editor-tab active">Fix this Issues</button>
                            </div>
                            <div class="editor-actions">
                                <button class="editor-btn copy-btn" onclick="copyCode('exercise1')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="editor-btn run-btn" onclick="checkExercise1()">
                                    <i class="fas fa-play"></i> Test Fixes
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-input" id="exercise1-code">
const car = {
    brand: "Tesla",
    model: "Model S",
    speed: 0,
    maxSpeed: 200,
    
    // Fix this method - it should use 'this' to access car properties
    accelerate(amount) {
        speed += amount;  // Problem: should be this.speed
        if (speed > maxSpeed) {  // Problem: should be this.speed and this.maxSpeed
            speed = maxSpeed;
        }
        return `${brand} ${model} is now going ${speed} mph`;  // Problems: brand, model, speed
    },
    
    // Fix this method - it should use 'this'
    brake(amount) {
        speed -= amount;  // Problem: should be this.speed
        if (speed < 0) {  // Problem: should be this.speed
            speed = 0;
        }
        return `Slowing down... now at ${speed} mph`;  // Problem: should be this.speed
    },
    
    // Fix this method
    getInfo() {
        return `Vehicle: ${brand} ${model}, Speed: ${speed}/${maxSpeed} mph`;  // Problems: missing this
    }
};

// Test the fixed methods
console.log("Starting tests...");
console.log(car.accelerate(50));
console.log(car.accelerate(30));
console.log(car.brake(20));
console.log(car.getInfo());
console.log(car.accelerate(200));  // Should hit max speed
console.log(car.brake(300));       // Should not go below 0
console.log(car.getInfo());
</textarea>
                            <div class="code-output">
                                <div class="output-label">Output will appear here...</div>
                                <pre id="exercise1-output"></pre>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-feedback" id="exercise1-feedback"></div>
                </div>
            </section>

            <!-- Practice Exercise 2 -->
            <section class="exercise-section">
                <div class="exercise-header">
                    <h3><i class="fas fa-puzzle-piece"></i> Practice Exercise 2: this Keyword Quiz</h3>
                </div>
                <div class="exercise-content">
                    <p>What will `this.name` return when `person.introduce()` is called?</p>
                    <pre><code>const person = {
    name: "Emma",
    age: 25,
    introduce() {
        return `Hi, I'm ${this.name}`;
    }
};

person.introduce();</code></pre>
                    <div class="exercise-options" id="exercise2">
                        <button class="option-btn" data-answer="wrong">undefined</button>
                        <button class="option-btn" data-answer="correct">"Emma"</button>
                        <button class="option-btn" data-answer="wrong">error</button>
                        <button class="option-btn" data-answer="wrong">"this.name"</button>
                    </div>
                    <div class="exercise-feedback" id="exercise2-feedback"></div>
                </div>
            </section>

            <!-- Practice Exercise 3 -->
            <section class="exercise-section">
                <div class="exercise-header">
                    <h3><i class="fas fa-puzzle-piece"></i> Practice Exercise 3: Create a Timer Object</h3>
                </div>
                <div class="exercise-content">
                    <p>Create a stopwatch object with methods that use `this` correctly:</p>
                    
                    <div class="code-editor" id="exercise3">
                        <div class="editor-header">
                            <div class="editor-tabs">
                                <button class="editor-tab active">Stopwatch Object</button>
                            </div>
                            <div class="editor-actions">
                                <button class="editor-btn copy-btn" onclick="copyCode('exercise3')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="editor-btn run-btn" onclick="checkExercise3()">
                                    <i class="fas fa-play"></i> Test Stopwatch
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-input" id="exercise3-code">
const stopwatch = {
    name: "Digital Stopwatch",
    time: 0,
    isRunning: false,
    
    start() {
        // Set isRunning to true using 'this'
        // Return a message like "Digital Stopwatch started"
        
    },
    
    stop() {
        // Set isRunning to false using 'this'
        // Return a message like "Digital Stopwatch stopped at 5 seconds"
        
    },
    
    tick() {
        // Only increase time if isRunning is true
        // Use 'this' to access and modify time and isRunning
        // Return the current time
        
    },
    
    reset() {
        // Set time to 0 and isRunning to false
        // Return a message like "Digital Stopwatch reset"
        
    },
    
    getStatus() {
        // Return an object with name, time, and isRunning
        // Use 'this' to access all properties
        return {
            
        };
    }
};

// Test your stopwatch
console.log(stopwatch.start());
console.log("Time:", stopwatch.tick());
console.log("Time:", stopwatch.tick());
console.log("Time:", stopwatch.tick());
console.log(stopwatch.stop());
console.log("Status:", stopwatch.getStatus());
console.log(stopwatch.reset());
</textarea>
                            <div class="code-output">
                                <div class="output-label">Output will appear here...</div>
                                <pre id="exercise3-output"></pre>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-feedback" id="exercise3-feedback"></div>
                </div>
            </section>

            <!-- Common Mistakes Section -->
            <section class="content-section">
                <h2>Common Mistakes to Avoid</h2>
                <div class="mistake-box">
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Forgetting 'this' When Accessing Object Properties</strong>
                            <p>Inside object methods, always use `this.propertyName` to access the object's properties. Writing just `propertyName` will look for a variable in the outer scope, not the object's property.</p>
                        </div>
                    </div>
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Extracting Methods Without Binding</strong>
                            <p>When you store an object method in a variable (`const func = obj.method`), `this` loses its connection to the original object. Use `bind()` or call the method directly on the object.</p>
                        </div>
                    </div>
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Using Arrow Functions for Object Methods</strong>
                            <p>Arrow functions don't have their own `this` context. When used as object methods, `this` won't refer to the object. Stick to regular function syntax for object methods.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="content-section">
                <h2>Summary</h2>
                <div class="summary-box">
                    <h3>Key Takeaways:</h3>
                    <ul>
                        <li>The `this` keyword refers to the object that called the current method</li>
                        <li>Always use `this.propertyName` to access object properties inside methods</li>
                        <li>When you extract a method from an object, `this` loses its connection to the original object</li>
                        <li>Use `bind()` to permanently attach `this` to a specific object for extracted methods</li>
                        <li>Arrow functions inherit `this` from their surrounding context and shouldn't be used as object methods</li>
                    </ul>
                </div>
            </section>

            <!-- Spacing before navigation -->
            <div style="margin: 2rem 0;"></div>
            
            <!-- Lesson Navigation -->
            <div class="lesson-navigation">
                <button class="btn btn-secondary" onclick="window.location.href='lesson2.html'">
                    <i class="fas fa-arrow-left"></i> Previous Lesson
                </button>
                
                <button class="btn btn-primary" onclick="completeLesson()">
                    Complete Lesson <i class="fas fa-check"></i>
                </button>
                
                <button class="btn btn-secondary" onclick="window.location.href='lesson4.html'">
                    Next Lesson <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </article>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <p>Made by TayMcQuaya with <span class="heart">❤️</span></p>
            <div class="social-links">
                <a href="https://taymcquaya.com" target="_blank" rel="noopener noreferrer" aria-label="Personal Website">
                    <i class="fas fa-globe"></i>
                </a>
                <a href="https://x.com/TayMcQuaya" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
                <a href="https://github.com/TayMcQuaya" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                    <i class="fab fa-github"></i>
                </a>
            </div>
            <div class="copyright">
                <p>&copy; 2025 JavaScript Journey&trade; - All rights reserved</p>
            </div>
        </div>
    </footer>

    <!-- Reset Modal -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>Reset Progress</h3>
            <p>Choose what you want to reset:</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="resetAllBtn">Reset All Progress</button>
                <button class="btn btn-warning" id="resetModuleBtn">Reset Current Module</button>
                <button class="btn btn-secondary" id="cancelResetBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/app.js"></script>
    <script src="../../js/storage.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/progress.js"></script>
    <script src="../../js/exercises.js"></script>
    <script src="../../js/modal.js"></script>
    <script>
        // Complete lesson function
        function completeLesson() {
            Storage.saveProgress(7, 3, true);
            customModal.success('Outstanding! You now understand the mysterious "this" keyword - one of JavaScript\'s most important concepts.', 'Congratulations!');
            
            setTimeout(() => {
                window.location.href = 'lesson4.html';
            }, 2000);
        }

        // Copy code function
        function copyCode(editorId) {
            const codeInput = document.getElementById(`${editorId}-code`);
            if (!codeInput) return;
            
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                const button = event.target.closest('.editor-btn');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }

        // Run code function
        function runCode(editorId) {
            const codeInput = document.getElementById(`${editorId}-code`);
            const outputPane = document.getElementById(`${editorId}-output`);
            
            if (!codeInput || !outputPane) return;
            
            const code = codeInput.value;
            
            // Clear the parent container to remove the "Output will appear here..." label
            const outputContainer = outputPane.parentElement;
            const outputLabel = outputContainer.querySelector('.output-label');
            if (outputLabel) {
                outputLabel.style.display = 'none';
            }
            
            outputPane.innerHTML = '';
            
            const originalConsoleLog = console.log;
            const logs = [];
            
            console.log = (...args) => {
                logs.push(args.map(arg => {
                    if (typeof arg === 'object') {
                        return JSON.stringify(arg, null, 2);
                    }
                    return String(arg);
                }).join(' '));
            };
            
            try {
                eval(code);
                
                if (logs.length > 0) {
                    outputPane.innerHTML = logs.map(log => 
                        `<div class="output-line">${escapeHtml(log)}</div>`
                    ).join('');
                } else {
                    outputPane.innerHTML = '<div class="output-line muted">No output</div>';
                }
            } catch (error) {
                outputPane.innerHTML = `<div class="output-error">Error: ${escapeHtml(error.message)}</div>`;
            } finally {
                console.log = originalConsoleLog;
            }
        }

        // Escape HTML function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Exercise 1 checker
        function checkExercise1() {
            const code = document.getElementById('exercise1-code').value;
            const output = document.getElementById('exercise1-output');
            const feedback = document.getElementById('exercise1-feedback');
            
            // Clear the parent container to remove the "Output will appear here..." label
            const outputContainer = output.parentElement;
            const outputLabel = outputContainer.querySelector('.output-label');
            if (outputLabel) {
                outputLabel.style.display = 'none';
            }
            
            // Run the code first to show output
            runCode('exercise1');
            
            // Check if the output contains any errors
            const outputHasError = output.innerHTML.includes('output-error') || 
                                  output.innerHTML.includes('Error:');
            
            const hasThisSpeed = code.includes('this.speed');
            const hasThisMaxSpeed = code.includes('this.maxSpeed');
            const hasThisBrand = code.includes('this.brand');
            const hasThisModel = code.includes('this.model');
            const fixedAccelerate = code.includes('this.speed += amount') || code.includes('this.speed = this.speed + amount');
            const fixedBrake = code.includes('this.speed -= amount') || code.includes('this.speed = this.speed - amount');
            
            // Hide feedback first to create animation effect
            feedback.style.display = 'none';
            feedback.className = 'exercise-feedback';
            feedback.classList.remove('show', 'success', 'error');
            
            setTimeout(() => {
                feedback.style.display = 'block';
                if (!outputHasError && hasThisSpeed && hasThisMaxSpeed && hasThisBrand && hasThisModel && fixedAccelerate && fixedBrake) {
                    feedback.className = 'exercise-feedback show success';
                    feedback.textContent = 'Perfect! You successfully fixed all the "this" keyword issues. The car object now works correctly!';
                } else if (outputHasError) {
                    feedback.className = 'exercise-feedback show error';
                    feedback.textContent = 'Your code still has errors. Make sure to replace all property references with "this.propertyName".';
                } else {
                    feedback.className = 'exercise-feedback show error';
                    let missing = [];
                    if (!hasThisSpeed) missing.push('this.speed');
                    if (!hasThisMaxSpeed) missing.push('this.maxSpeed');
                    if (!hasThisBrand) missing.push('this.brand');
                    if (!hasThisModel) missing.push('this.model');
                    feedback.textContent = `You still need to fix these references: ${missing.join(', ')}. Remember to use "this." before property names.`;
                }
            }, 150);
        }

        // Exercise 3 checker
        function checkExercise3() {
            const code = document.getElementById('exercise3-code').value;
            const output = document.getElementById('exercise3-output');
            const feedback = document.getElementById('exercise3-feedback');
            
            // Clear the parent container to remove the "Output will appear here..." label
            const outputContainer = output.parentElement;
            const outputLabel = outputContainer.querySelector('.output-label');
            if (outputLabel) {
                outputLabel.style.display = 'none';
            }
            
            // Run the code first to show output
            runCode('exercise3');
            
            // Check if the output contains any errors
            const outputHasError = output.innerHTML.includes('output-error') || 
                                  output.innerHTML.includes('Error:');
            
            const hasStartMethod = code.includes('this.isRunning') && code.includes('start()') && code.includes('return');
            const hasStopMethod = code.includes('stop()') && code.includes('this.isRunning') && code.includes('return');
            const hasTickMethod = code.includes('tick()') && code.includes('this.time') && code.includes('this.isRunning');
            const hasResetMethod = code.includes('reset()') && code.includes('this.time') && code.includes('0');
            const hasGetStatusMethod = code.includes('getStatus()') && code.includes('this.name') && code.includes('this.time');
            
            // Hide feedback first to create animation effect
            feedback.style.display = 'none';
            feedback.className = 'exercise-feedback';
            feedback.classList.remove('show', 'success', 'error');
            
            setTimeout(() => {
                feedback.style.display = 'block';
                if (!outputHasError && hasStartMethod && hasStopMethod && hasTickMethod && hasResetMethod && hasGetStatusMethod) {
                    feedback.className = 'exercise-feedback show success';
                    feedback.textContent = 'Excellent! Your stopwatch object uses "this" correctly in all methods. You have mastered the this keyword!';
                } else if (outputHasError) {
                    feedback.className = 'exercise-feedback show error';
                    feedback.textContent = 'Your code has errors. Make sure all methods are properly implemented with "this" references.';
                } else {
                    feedback.className = 'exercise-feedback show error';
                    let missing = [];
                    if (!hasStartMethod) missing.push('start() method');
                    if (!hasStopMethod) missing.push('stop() method');
                    if (!hasTickMethod) missing.push('tick() method');
                    if (!hasResetMethod) missing.push('reset() method');
                    if (!hasGetStatusMethod) missing.push('getStatus() method');
                    feedback.textContent = `Incomplete implementations: ${missing.join(', ')}. Make sure each method uses "this" to access object properties.`;
                }
            }, 150);
        }

        // Exercise 2 - Multiple choice handler
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.option-btn').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    const exerciseContainer = this.closest('.exercise-options');
                    const feedbackDiv = this.closest('.exercise-content').querySelector('.exercise-feedback');
                    const isCorrect = this.getAttribute('data-answer') === 'correct';
                    
                    // Remove previous incorrect selections (but not correct ones)
                    exerciseContainer.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.classList.contains('incorrect')) {
                            btn.classList.remove('incorrect', 'selected');
                            btn.disabled = false;
                        }
                    });
                    
                    // Hide feedback first to create animation effect
                    if (feedbackDiv) {
                        feedbackDiv.style.display = 'none';
                        feedbackDiv.className = 'exercise-feedback';
                        feedbackDiv.classList.remove('show', 'success', 'error');
                    }
                    
                    // Mark this button
                    this.classList.add('selected');
                    this.classList.add(isCorrect ? 'correct' : 'incorrect');
                    
                    if (isCorrect) {
                        // Correct answer - disable all buttons
                        exerciseContainer.querySelectorAll('.option-btn').forEach(btn => {
                            btn.disabled = true;
                        });
                    } else {
                        // Wrong answer - disable only this button
                        this.disabled = true;
                    }
                    
                    // Show feedback with animation
                    if (feedbackDiv) {
                        setTimeout(() => {
                            feedbackDiv.style.display = 'block';
                            feedbackDiv.className = 'exercise-feedback show ' + (isCorrect ? 'success' : 'error');
                            if (isCorrect) {
                                feedbackDiv.textContent = 'Correct! When person.introduce() is called, "this" refers to the person object, so this.name returns "Emma".';
                            } else {
                                feedbackDiv.textContent = 'Not quite. Remember, when a method is called on an object, "this" refers to that object.';
                            }
                        }, 150);
                    }
                });
            });
        });
    </script>
</body>
</html>