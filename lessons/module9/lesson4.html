<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson 4: Event Delegation - JavaScript Journey</title>
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/themes.css">
    <link rel="stylesheet" href="../../styles/lesson.css">
    <link rel="stylesheet" href="../../styles/dark-mode-fixes.css">
    <link rel="stylesheet" href="../../styles/code-highlighting.css">
    <link rel="stylesheet" href="../../styles/footer.css">
    <link rel="stylesheet" href="../../styles/header-enhanced.css">
    <link rel="stylesheet" href="../../styles/modal.css">
    <link rel="stylesheet" href="../../styles/style-guide.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="../../index.html" style="text-decoration: none; color: inherit;">
                    <i class="fas fa-code"></i>
                    <span>JavaScript Journey</span>
                </a>
            </div>
            <div class="nav-menu">
                <button class="nav-btn" onclick="window.location.href='../../index.html'">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </button>
                <button class="nav-btn" id="progressBtn">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </button>
                <button class="nav-btn" id="resetBtn">
                    <i class="fas fa-redo"></i>
                    <span>Reset</span>
                </button>
                <button class="nav-btn" id="themeBtn">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="lesson-container">
        <article class="lesson-content">
            <!-- Lesson Header -->
            <div class="lesson-header">
                <h1>Module 9:<br>Lesson 4: Event Delegation</h1>
                <p class="lesson-subtitle">Use event bubbling to efficiently handle events from multiple elements</p>
            </div>

            <!-- Introduction Section -->
            <section class="content-section">
                <h2>Introduction</h2>
                <p>Event delegation is a powerful pattern that uses event bubbling to handle events from multiple child elements with a single event listener on their parent. Instead of attaching listeners to each child, you attach one listener to the parent and use the event target to determine which child was clicked.</p>
                <p>Imagine you're a teacher managing a classroom. Instead of giving each student individual instructions, you give one set of instructions to the class monitor who then determines which student needs what. Event delegation works the same way - one parent listener manages events for all its children.</p>
            </section>

            <!-- Core Content Section 1 -->
            <section class="content-section">
                <h2>Why Event Delegation?</h2>
                <p>Event delegation solves several common problems in web development. It's more efficient for handling events on many elements, works automatically with dynamically added elements, and reduces memory usage by using fewer event listeners.</p>

                <!-- Info Box -->
                <div class="info-box">
                    <div>
                        <i class="fas fa-lightbulb"></i> <strong> Key Benefit:</strong>
                        <p>Elements added after page load automatically work with event delegation - no need to attach new listeners!</p>
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="code-editor" id="editor1">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">Basic Event Delegation</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor1')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor1')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor1-code">
// Without event delegation - inefficient way
// Imagine having 100 buttons - you'd need 100 listeners!

// With event delegation - efficient way
const container = document.createElement('div');
container.style.cssText = `
    padding: 1.5rem;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
`;

// Create multiple buttons
for (let i = 1; i <= 12; i++) {
    const button = document.createElement('button');
    button.textContent = `Button ${i}`;
    button.dataset.id = i; // Store data in the element
    button.style.cssText = `
        padding: 0.75rem 1.5rem;
        background: white;
        color: #764ba2;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    `;
    container.appendChild(button);
}

// Single event listener on the parent (delegation)
container.addEventListener('click', function(e) {
    // Check if a button was clicked
    if (e.target.tagName === 'BUTTON') {
        const buttonId = e.target.dataset.id;
        console.log(`Button ${buttonId} clicked!`);
        
        // Visual feedback
        e.target.style.background = '#10b981';
        e.target.style.color = 'white';
        e.target.style.transform = 'scale(1.1)';
        
        setTimeout(() => {
            e.target.style.background = 'white';
            e.target.style.color = '#764ba2';
            e.target.style.transform = 'scale(1)';
        }, 500);
    }
});

// Add more buttons dynamically
const addButton = document.createElement('button');
addButton.textContent = '+ Add New Button';
addButton.style.cssText = `
    margin-top: 1rem;
    padding: 0.75rem 2rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1.1rem;
`;

let buttonCount = 12;
addButton.addEventListener('click', function() {
    buttonCount++;
    const newButton = document.createElement('button');
    newButton.textContent = `Button ${buttonCount}`;
    newButton.dataset.id = buttonCount;
    newButton.style.cssText = `
        padding: 0.75rem 1.5rem;
        background: white;
        color: #764ba2;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    `;
    container.appendChild(newButton);
    console.log(`Added Button ${buttonCount} - it works immediately!`);
});

document.body.appendChild(container);
document.body.appendChild(addButton);

console.log('Click any button - even newly added ones work automatically!');</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor1-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Core Content Section 2 -->
            <section class="content-section">
                <h2>Practical Example: Todo List</h2>
                <p>Event delegation is perfect for interactive lists where items can be added, removed, or modified. Let's build a todo list that demonstrates this pattern in action.</p>

                <div class="code-editor" id="editor2">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">Todo List with Delegation</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor2')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor2')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor2-code">
// Create a todo list with event delegation
const app = document.createElement('div');
app.style.cssText = `
    max-width: 400px;
    margin: 0 auto;
    padding: 1.5rem;
    background: #f3f4f6;
    border-radius: 1rem;
`;

// Header and input
app.innerHTML = `
    <h3 style="margin: 0 0 1rem 0; color: #1f2937;">üìù My Todo List</h3>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <input type="text" id="todoInput" placeholder="Add a new task..." style="
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            color: var(--text-primary);
        ">
        <button id="addBtn" style="
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        ">Add</button>
    </div>
    <ul id="todoList" style="
        list-style: none;
        padding: 0;
        margin: 0;
    "></ul>
`;

document.body.appendChild(app);

const todoList = document.getElementById('todoList');
const todoInput = document.getElementById('todoInput');
const addBtn = document.getElementById('addBtn');

let todoId = 0;
const todos = [];

// Function to add a todo
function addTodo(text) {
    todoId++;
    const todo = { id: todoId, text, completed: false };
    todos.push(todo);
    
    const li = document.createElement('li');
    li.dataset.id = todo.id;
    li.style.cssText = `
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: white;
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s;
    `;
    
    li.innerHTML = `
        <input type="checkbox" class="todo-check" ${todo.completed ? 'checked' : ''} style="
            width: 20px;
            height: 20px;
            cursor: pointer;
        ">
        <span class="todo-text" style="
            flex: 1;
            color: var(--text-primary);
            ${todo.completed ? 'text-decoration: line-through; opacity: 0.5;' : ''}
        ">${text}</span>
        <button class="delete-btn" style="
            padding: 0.25rem 0.75rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
        ">Delete</button>
    `;
    
    todoList.appendChild(li);
    console.log(`Added todo: "${text}"`);
}

// EVENT DELEGATION - Single listener for all todo interactions
todoList.addEventListener('click', function(e) {
    const li = e.target.closest('li');
    if (!li) return;
    
    const todoId = parseInt(li.dataset.id);
    const todo = todos.find(t => t.id === todoId);
    
    // Handle checkbox clicks
    if (e.target.classList.contains('todo-check')) {
        todo.completed = e.target.checked;
        const text = li.querySelector('.todo-text');
        
        if (todo.completed) {
            text.style.textDecoration = 'line-through';
            text.style.opacity = '0.5';
            li.style.background = '#f0f0f0';
            console.log(`Completed: "${todo.text}"`);
        } else {
            text.style.textDecoration = 'none';
            text.style.opacity = '1';
            li.style.background = 'white';
            console.log(`Uncompleted: "${todo.text}"`);
        }
    }
    
    // Handle delete button clicks
    if (e.target.classList.contains('delete-btn')) {
        li.style.transform = 'translateX(100%)';
        li.style.opacity = '0';
        
        setTimeout(() => {
            li.remove();
            const index = todos.findIndex(t => t.id === todoId);
            console.log(`Deleted: "${todos[index].text}"`);
            todos.splice(index, 1);
        }, 300);
    }
});

// Add todo on button click
addBtn.addEventListener('click', function() {
    const text = todoInput.value.trim();
    if (text) {
        addTodo(text);
        todoInput.value = '';
        todoInput.focus();
    }
});

// Add todo on Enter key
todoInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const text = this.value.trim();
        if (text) {
            addTodo(text);
            this.value = '';
        }
    }
});

// Add some sample todos
addTodo('Learn event delegation');
addTodo('Build interactive apps');
addTodo('Master JavaScript events');

todoInput.focus();</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor2-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Core Content Section 3 -->
            <section class="content-section">
                <h2>Using closest() for Reliable Targeting</h2>
                <p>The closest() method is essential for event delegation. It searches up the DOM tree from the target element to find the nearest ancestor that matches a selector. This is more reliable than checking e.target directly.</p>

                <div class="warning-box">
                    <div>
                        <i class="fas fa-exclamation-triangle"></i> <strong> Important:</strong>
                        <p>Always use e.target.closest() when the clickable element has child elements. Direct e.target checks can fail when clicking on nested elements.</p>
                    </div>
                </div>

                <div class="code-editor" id="editor3">
                    <div class="editor-header">
                        <div class="editor-tabs">
                            <button class="editor-tab active">Using closest()</button>
                        </div>
                        <div class="editor-actions">
                            <button class="editor-btn copy-btn" onclick="copyCode('editor3')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button class="editor-btn run-btn" onclick="runCode('editor3')">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                        </div>
                    </div>
                    <div class="editor-content">
                        <textarea class="code-input" id="editor3-code">
// Create cards with nested elements
const gallery = document.createElement('div');
gallery.style.cssText = `
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 1rem;
`;

// Create cards with complex structure
const cards = [
    { id: 1, title: 'Card 1', icon: 'üé®' },
    { id: 2, title: 'Card 2', icon: 'üé≠' },
    { id: 3, title: 'Card 3', icon: 'üé™' },
    { id: 4, title: 'Card 4', icon: 'üéØ' }
];

cards.forEach(card => {
    const cardEl = document.createElement('div');
    cardEl.className = 'card';
    cardEl.dataset.id = card.id;
    cardEl.style.cssText = `
        padding: 1rem;
        background: white;
        border-radius: 0.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    cardEl.innerHTML = `
        <div style="font-size: 2rem;">${card.icon}</div>
        <h4 style="margin: 0.5rem 0; color: #1f2937;">${card.title}</h4>
        <button class="action-btn" style="
            padding: 0.5rem 1rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
        ">Action</button>
    `;
    
    gallery.appendChild(cardEl);
});

// Event delegation with closest()
gallery.addEventListener('click', function(e) {
    // Find the card that was clicked
    const card = e.target.closest('.card');
    if (!card) return;
    
    const cardId = card.dataset.id;
    
    // Check if action button was clicked
    if (e.target.closest('.action-btn')) {
        e.stopPropagation(); // Stop card click
        console.log(`Action button clicked on card ${cardId}`);
        
        // Change button color
        e.target.style.background = '#10b981';
        setTimeout(() => {
            e.target.style.background = '#3b82f6';
        }, 500);
    } else {
        // Card itself was clicked
        console.log(`Card ${cardId} clicked`);
        
        // Highlight card
        card.style.transform = 'scale(1.05)';
        card.style.boxShadow = '0 8px 16px rgba(0,0,0,0.2)';
        
        setTimeout(() => {
            card.style.transform = 'scale(1)';
            card.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        }, 300);
    }
});

document.body.appendChild(gallery);

console.log('Click on cards or their buttons - closest() handles nested elements!');</textarea>
                        <div class="code-output">
                            <div class="output-label">Output will appear here...</div>
                            <pre id="editor3-output"></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Practice Exercises -->
            <section class="exercise-section">
                <div class="exercise-header">
                    <h3><i class="fas fa-puzzle-piece"></i> Practice Exercise 1: Dynamic Button List</h3>
                </div>
                <div class="exercise-content">
                    <p>Create a button list where clicking buttons removes them, using event delegation.</p>
                    <div class="code-editor" id="exercise1">
                        <div class="editor-header">
                            <div class="editor-tabs">
                                <button class="editor-tab active">Complete the Code</button>
                            </div>
                            <div class="editor-actions">
                                <button class="editor-btn copy-btn" onclick="copyCode('exercise1')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="editor-btn run-btn" onclick="checkExercise1()">
                                    <i class="fas fa-play"></i> Check Solution
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-input" id="exercise1-code">
// Create a list where buttons can be removed by clicking
const container = document.createElement('div');
container.style.cssText = `
    padding: 1.5rem;
    background: #f3f4f6;
    border-radius: 0.5rem;
`;

// Add initial buttons
for (let i = 1; i <= 5; i++) {
    const btn = document.createElement('button');
    btn.textContent = `Remove Me ${i}`;
    btn.dataset.id = i;
    btn.style.cssText = `
        display: block;
        width: 100%;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: #6366f1;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    `;
    container.appendChild(btn);
}

// TODO: Add event delegation to remove buttons when clicked
// Use a single event listener on the container
// When a button is clicked, remove it with a fade effect

// Add your code here


document.body.appendChild(container);</textarea>
                            <div class="code-output">
                                <div class="output-label">Output will appear here...</div>
                                <pre id="exercise1-output"></pre>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-feedback" id="exercise1-feedback"></div>
                </div>
            </section>

            <section class="exercise-section">
                <div class="exercise-header">
                    <h3><i class="fas fa-puzzle-piece"></i> Practice Exercise 2: Accordion Menu</h3>
                </div>
                <div class="exercise-content">
                    <p>Build an accordion menu where clicking headers toggles content visibility using event delegation.</p>
                    <div class="code-editor" id="exercise2">
                        <div class="editor-header">
                            <div class="editor-tabs">
                                <button class="editor-tab active">Complete the Code</button>
                            </div>
                            <div class="editor-actions">
                                <button class="editor-btn copy-btn" onclick="copyCode('exercise2')">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                                <button class="editor-btn run-btn" onclick="checkExercise2()">
                                    <i class="fas fa-play"></i> Check Solution
                                </button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-input" id="exercise2-code">
// Create an accordion with event delegation
const accordion = document.createElement('div');
accordion.style.cssText = `
    max-width: 500px;
    margin: 0 auto;
`;

const sections = [
    { title: 'What is JavaScript?', content: 'JavaScript is a programming language for the web.' },
    { title: 'Why learn events?', content: 'Events make your websites interactive and responsive.' },
    { title: 'What is delegation?', content: 'Delegation uses one listener for multiple elements.' }
];

// Create accordion sections
sections.forEach((section, index) => {
    const item = document.createElement('div');
    item.innerHTML = `
        <div class="accordion-header" data-index="${index}" style="
            padding: 1rem;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <span>${section.title}</span>
            <span class="arrow">‚ñº</span>
        </div>
        <div class="accordion-content" style="
            padding: 1rem;
            background: #f3f4f6;
            color: var(--text-primary);
            display: none;
        ">
            ${section.content}
        </div>
    `;
    accordion.appendChild(item);
});

// TODO: Add event delegation to toggle accordion sections
// Click on header should show/hide content
// Only one section should be open at a time

// Add your code here


document.body.appendChild(accordion);</textarea>
                            <div class="code-output">
                                <div class="output-label">Output will appear here...</div>
                                <pre id="exercise2-output"></pre>
                            </div>
                        </div>
                    </div>
                    <div class="exercise-feedback" id="exercise2-feedback"></div>
                </div>
            </section>

            <!-- Common Mistakes Section -->
            <section class="content-section">
                <h2>Common Mistakes to Avoid</h2>
                <div class="mistake-box">
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Forgetting to Check the Target</strong>
                            <p>Always verify the clicked element is what you expect using e.target checks or closest(). Without this check, you might handle clicks on the wrong elements.</p>
                        </div>
                    </div>
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Not Using stopPropagation When Needed</strong>
                            <p>When handling nested elements, use e.stopPropagation() to prevent unwanted parent handlers from firing.</p>
                        </div>
                    </div>
                    <div class="mistake-item">
                        <div>
                            <i class="fas fa-times-circle"></i> <strong> Attaching Listeners in Loops</strong>
                            <p>Don't attach listeners inside loops. Use delegation on the parent instead for better performance and cleaner code.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Summary Section -->
            <section class="content-section">
                <h2>Summary</h2>
                <div class="summary-box">
                    <h3>Key Takeaways:</h3>
                    <ul>
                        <li>Event delegation uses one listener to handle events from multiple elements</li>
                        <li>It works by utilizing event bubbling - events bubble up from child to parent</li>
                        <li>Perfect for dynamic content - new elements automatically work</li>
                        <li>Use e.target to identify which element was clicked</li>
                        <li>Use closest() to find the parent element you're interested in</li>
                        <li>More efficient than adding individual listeners to many elements</li>
                    </ul>
                </div>
            </section>

            <!-- Spacing before navigation -->
            <div style="margin: 2rem 0;"></div>
            
            <!-- Lesson Navigation -->
            <div class="lesson-navigation">
                <button class="btn btn-secondary" onclick="window.location.href='lesson3.html'">
                    <i class="fas fa-arrow-left"></i> Previous Lesson
                </button>
                
                <button class="btn btn-primary" onclick="completeLesson()">
                    Complete Module 9 <i class="fas fa-check"></i>
                </button>
                
                <button class="btn btn-secondary" onclick="app.startNextModule(9)">
                    Start Module 10 <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </article>
    </main>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <p>Made by TayMcQuaya with <span class="heart">‚ù§Ô∏è</span></p>
            <div class="social-links">
                <a href="https://github.com/TayMcQuaya" target="_blank" rel="noopener noreferrer" aria-label="GitHub">
                    <i class="fab fa-github"></i>
                </a>
                <a href="https://x.com/TayMcQuaya" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter)">
                    <i class="fa-brands fa-x-twitter"></i>
                </a>
            </div>
            <div class="copyright">
                <p>&copy; 2025 JavaScript Journey&trade; - All rights reserved</p>
            </div>
        </div>
    </footer>

    <!-- Reset Modal -->
    <div class="modal" id="resetModal">
        <div class="modal-content">
            <h3>Reset Progress</h3>
            <p>Choose what you want to reset:</p>
            <div class="modal-buttons">
                <button class="btn btn-danger" id="resetAllBtn">Reset All Progress</button>
                <button class="btn btn-warning" id="resetModuleBtn">Reset Current Module</button>
                <button class="btn btn-secondary" id="cancelResetBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../../js/app.js"></script>
    <script src="../../js/storage.js"></script>
    <script src="../../js/navigation.js"></script>
    <script src="../../js/progress.js"></script>
    <script src="../../js/exercises.js"></script>
    <script src="../../js/modal.js"></script>
    <script>
        // Run code function for Module 9 (events need interactive demos)
        function runCode(editorId) {
            const codeInput = document.getElementById(`${editorId}-code`);
            const outputPane = document.getElementById(`${editorId}-output`);
            
            if (!codeInput || !outputPane) return;
            
            const code = codeInput.value;
            
            // Hide output label
            const outputContainer = outputPane.parentElement;
            const outputLabel = outputContainer.querySelector('.output-label');
            if (outputLabel) {
                outputLabel.style.display = 'none';
            }
            
            // For Module 9, create demos outside the output box
            outputPane.innerHTML = '<div style="color: var(--js-yellow); font-style: italic;">Building interactive demo outside of this box...</div>';
            
            // Remove any existing demo
            const existingDemo = document.getElementById(`${editorId}-demo`);
            if (existingDemo) {
                existingDemo.remove();
            }
            
            // Create demo container
            const demoContainer = document.createElement('div');
            demoContainer.id = `${editorId}-demo`;
            demoContainer.style.cssText = 'margin: 2rem 0; padding: 1rem; background: var(--bg-secondary); border-radius: 0.5rem;';
            
            // Insert demo after the editor
            const editor = document.getElementById(editorId);
            editor.insertAdjacentElement('afterend', demoContainer);
            
            // Capture console output
            const originalConsoleLog = console.log;
            const logs = [];
            
            console.log = (...args) => {
                logs.push(args.map(arg => {
                    if (typeof arg === 'object') {
                        return JSON.stringify(arg, null, 2);
                    }
                    return String(arg);
                }).join(' '));
                originalConsoleLog(...args);
            };
            
            try {
                // Override document.body.appendChild to append to demo container
                const originalAppendChild = document.body.appendChild;
                document.body.appendChild = function(element) {
                    return demoContainer.appendChild(element);
                };
                
                eval(code);
                
                // Restore original appendChild
                document.body.appendChild = originalAppendChild;
                
                // Show console output
                if (logs.length > 0) {
                    outputPane.innerHTML = '<div style="color: var(--js-yellow);">Console output:</div>' + 
                        logs.slice(0, 10).map(log => `<div style="color: var(--js-yellow);">${log}</div>`).join('');
                }
            } catch (error) {
                outputPane.innerHTML = `<div style="color: #ef4444;">Error: ${error.message}</div>`;
            } finally {
                console.log = originalConsoleLog;
            }
        }

        // Copy code function
        function copyCode(editorId) {
            const codeInput = document.getElementById(`${editorId}-code`);
            if (!codeInput) return;
            
            codeInput.select();
            codeInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                customModal.success('Code copied to clipboard!', 'Copied');
            } catch (err) {
                customModal.error('Failed to copy code', 'Error');
            }
        }

        // Exercise checkers
        function checkExercise1() {
            const code = document.getElementById('exercise1-code').value;
            const feedback = document.getElementById('exercise1-feedback');
            
            runCode('exercise1');
            
            const hasUserCode = !code.includes('// Add your code here') || 
                               code.includes('addEventListener') || 
                               code.includes('click');
            
            if (hasUserCode) {
                const solutionCode = code.replace(
                    '// Add your code here',
                    `container.addEventListener('click', function(e) {
    if (e.target.tagName === 'BUTTON') {
        // Add fade effect
        e.target.style.opacity = '0';
        e.target.style.transform = 'scale(0.8)';
        
        // Remove after animation
        setTimeout(() => {
            e.target.remove();
            console.log('Button removed!');
            
            // Check if all buttons are gone
            if (container.querySelectorAll('button').length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #10b981;">All buttons removed! üéâ</p>';
            }
        }, 300);
    }
});`
                );
                
                document.getElementById('exercise1-code').value = solutionCode;
                
                feedback.className = 'exercise-feedback success';
                feedback.innerHTML = '<i class="fas fa-check-circle"></i> Perfect! The solution shows how to use event delegation to handle all button clicks with one listener.';
            } else {
                feedback.className = 'exercise-feedback error';
                feedback.innerHTML = '<i class="fas fa-times-circle"></i> Try adding an event listener to the container that checks if a button was clicked.';
            }
            
            feedback.style.display = 'block';
        }

        function checkExercise2() {
            const code = document.getElementById('exercise2-code').value;
            const feedback = document.getElementById('exercise2-feedback');
            
            runCode('exercise2');
            
            const hasUserCode = !code.includes('// Add your code here') || 
                               code.includes('addEventListener') || 
                               code.includes('accordion-header');
            
            if (hasUserCode) {
                const solutionCode = code.replace(
                    '// Add your code here',
                    `accordion.addEventListener('click', function(e) {
    const header = e.target.closest('.accordion-header');
    if (!header) return;
    
    const content = header.nextElementSibling;
    const arrow = header.querySelector('.arrow');
    const isOpen = content.style.display === 'block';
    
    // Close all sections
    accordion.querySelectorAll('.accordion-content').forEach(c => {
        c.style.display = 'none';
    });
    accordion.querySelectorAll('.arrow').forEach(a => {
        a.textContent = '‚ñº';
    });
    
    // Toggle clicked section
    if (!isOpen) {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
        console.log('Opened:', header.textContent);
    } else {
        console.log('Closed:', header.textContent);
    }
});`
                );
                
                document.getElementById('exercise2-code').value = solutionCode;
                
                feedback.className = 'exercise-feedback success';
                feedback.innerHTML = '<i class="fas fa-check-circle"></i> Excellent! The accordion uses event delegation to handle all header clicks efficiently.';
            } else {
                feedback.className = 'exercise-feedback error';
                feedback.innerHTML = '<i class="fas fa-times-circle"></i> Try adding an event listener to the accordion that handles clicks on headers.';
            }
            
            feedback.style.display = 'block';
        }

        // Complete lesson function
        function completeLesson() {
            storageManager.markLessonCompleted(9, 4);
            const progress = storageManager.getModuleProgress(9);
            
            customModal.success(
                `üéâ Congratulations! You've completed Module 9: Events and Interactivity!<br><br>
                Module Progress: ${progress}%<br><br>
                You've mastered event handling, the event object, and event delegation. Ready for the final module?`,
                'Module Complete!'
            );
            
            setTimeout(() => {
                app.startNextModule(9);
            }, 3000);
        }
    </script>
</body>
</html>